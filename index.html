<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autorellenador de plantillas Word</title>
  <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f4f6fb;
      color: #1e1e2e;
      min-height: 100vh;
      padding: 3rem 1rem 4rem;
    }

    .container {
      max-width: 660px;
      margin: 0 auto;
    }

    .header {
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 800;
      color: #111;
      line-height: 1.2;
      margin-bottom: 0.6rem;
    }

    .subtitle {
      color: #5c5c7a;
      font-size: 0.93rem;
      line-height: 1.65;
    }

    .subtitle code {
      background: #ede9fe;
      color: #5b21b6;
      border-radius: 4px;
      padding: 0.1em 0.35em;
      font-size: 0.88em;
      font-family: 'Courier New', monospace;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 1.5rem;
      margin-top: 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
      border: 1px solid #e8eaf0;
    }

    .card-title {
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-bottom: 1.1rem;
    }

    .steps {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    .step {
      display: flex;
      gap: 0.9rem;
      align-items: flex-start;
    }

    .step-num {
      flex-shrink: 0;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #ede9fe;
      color: #6d28d9;
      font-size: 0.72rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 0.1rem;
    }

    .step-text {
      font-size: 0.875rem;
      color: #444;
      line-height: 1.65;
      min-width: 0;
    }

    .step-text code {
      background: #f3f4f6;
      color: #374151;
      border-radius: 4px;
      padding: 0.1em 0.35em;
      font-size: 0.85em;
      font-family: 'Courier New', monospace;
    }

    .step-text strong { color: #111; }

    .dropzone {
      background: #fff;
      border-radius: 14px;
      padding: 2.5rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
      position: relative;
      margin-top: 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
      border: 2px dashed #d1d5db;
    }

    .dropzone:hover,
    .dropzone.dragover {
      border-color: #6366f1;
      background: #fafafe;
      box-shadow: 0 0 0 4px rgba(99,102,241,0.08);
    }

    .dropzone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }

    .dropzone-icon {
      font-size: 2.2rem;
      margin-bottom: 0.6rem;
      filter: grayscale(0.2);
    }

    .dropzone-text {
      font-size: 0.95rem;
      font-weight: 500;
      color: #333;
    }

    .dropzone-hint {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 0.4rem;
    }

    .filename {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 1rem;
      background: #ede9fe;
      color: #5b21b6;
      border-radius: 999px;
      padding: 0.3rem 0.9rem;
      font-size: 0.83rem;
      font-weight: 600;
    }

    .tags-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tag-badge {
      background: #f3f0ff;
      color: #5b21b6;
      border: 1px solid #ddd6fe;
      border-radius: 6px;
      padding: 0.25rem 0.65rem;
      font-size: 0.8rem;
      font-weight: 600;
      font-family: 'Courier New', monospace;
      letter-spacing: 0.02em;
    }

    .form-grid {
      display: grid;
      gap: 1rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .field label {
      font-size: 0.83rem;
      font-weight: 600;
      color: #222;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .field label .tag-hint {
      font-family: 'Courier New', monospace;
      font-size: 0.73rem;
      color: #9ca3af;
      font-weight: 400;
      background: #f3f4f6;
      padding: 0.1em 0.4em;
      border-radius: 4px;
      word-break: break-all;
    }

    .field input {
      border: 1.5px solid #e5e7eb;
      border-radius: 9px;
      padding: 0.6rem 0.85rem;
      font-size: 0.93rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      width: 100%;
      color: #111;
      background: #fafafa;
    }

    .field input:focus {
      border-color: #6366f1;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(99,102,241,0.12);
    }

    .field input::placeholder { color: #c4c4d0; }

    .field input[type="date"] {
      width: 100%;
    }

    .divider {
      border: none;
      border-top: 1px solid #f0f0f5;
      margin: 1.25rem 0 1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 0.8rem 1.5rem;
      font-size: 0.97rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s, box-shadow 0.15s;
      width: 100%;
      box-shadow: 0 2px 8px rgba(99,102,241,0.3);
      letter-spacing: 0.01em;
    }

    .btn:hover { opacity: 0.92; box-shadow: 0 4px 14px rgba(99,102,241,0.4); }
    .btn:active { transform: scale(0.985); }
    .btn:disabled {
      background: linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 100%);
      box-shadow: none;
      cursor: not-allowed;
      opacity: 1;
    }

    .btn-pdf {
      background: #0f172a;
      box-shadow: 0 2px 8px rgba(15,23,42,0.3);
      margin-top: 0.6rem;
    }
    .btn-pdf:hover:not(:disabled) {
      background: #1e293b;
      box-shadow: 0 4px 14px rgba(15,23,42,0.4);
      opacity: 1;
    }
    .btn-pdf:disabled {
      background: #94a3b8;
      box-shadow: none;
    }



    .warning {
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: 9px;
      padding: 0.75rem 1rem;
      font-size: 0.81rem;
      color: #78350f;
      margin-bottom: 1rem;
      line-height: 1.6;
    }

    .success-msg {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 9px;
      padding: 0.75rem 1rem;
      font-size: 0.86rem;
      font-weight: 500;
      color: #15803d;
      margin-top: 0.85rem;
      display: none;
      text-align: center;
    }

    .hidden { display: none !important; }

    .tag-badge--gender {
      background: #fff0f6;
      color: #9d174d;
      border: 1px solid #fbcfe8;
      border-radius: 6px;
      padding: 0.25rem 0.65rem;
      font-size: 0.8rem;
      font-weight: 600;
      font-family: 'Courier New', monospace;
      letter-spacing: 0.02em;
    }

    .gender-section-label {
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
      border-top: 1px solid #f0f0f5;
      margin-top: 0.25rem;
    }

    .tag-badge--date {
      background: #f0fdf4;
      color: #15803d;
      border: 1px solid #bbf7d0;
      border-radius: 6px;
      padding: 0.25rem 0.65rem;
      font-size: 0.8rem;
      font-weight: 600;
      font-family: 'Courier New', monospace;
      letter-spacing: 0.02em;
    }

    .date-section-label {
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
      border-top: 1px solid #f0f0f5;
      margin-top: 0.25rem;
    }

    .segmented-control {
      display: inline-flex;
      border-radius: 8px;
      border: 1.5px solid #e5e7eb;
      overflow: hidden;
      background: #f9fafb;
      max-width: 100%;
    }

    .segmented-control input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .segmented-control label {
      padding: 0.45rem 1.1rem;
      font-size: 0.87rem;
      font-weight: 500;
      color: #6b7280;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      user-select: none;
    }

    .segmented-control input[type="radio"]:checked + label {
      background: #6366f1;
      color: #fff;
      font-weight: 600;
    }

    .gender-preview {
      font-size: 0.79rem;
      color: #6b7280;
      margin-top: 0.2rem;
    }

    .gender-preview strong {
      color: #374151;
    }

    .btn-reset {
      display: block;
      width: 100%;
      margin-top: 0.75rem;
      padding: 0.65rem;
      background: #fee2e2;
      color: #b91c1c;
      border: 1.5px solid #fca5a5;
      border-radius: 10px;
      font-size: 0.92rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }

    .btn-reset:hover {
      background: #fecaca;
      border-color: #f87171;
    }

    .step-text ul {
      margin-top: 0.6rem;
      padding-left: 1rem;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }

    .step-text li {
      position: relative;
    }

    .step-text li::before {
      content: '';
      position: absolute;
      left: -0.85rem;
      top: 0.55em;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #9ca3af;
    }

    .step-text code.c-text   { background: #ede9fe; color: #5b21b6; }
    .step-text code.c-date   { background: #f0fdf4; color: #15803d; }
    .step-text code.c-gender { background: #fff0f6; color: #9d174d; }

    .instr-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      border-radius: 6px;
      margin: -0.25rem;
      padding: 0.25rem;
      transition: background 0.15s;
    }
    .instr-header:hover { background: #f9fafb; }

    .instr-chevron {
      flex-shrink: 0;
      color: #9ca3af;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .instr-chevron.open { transform: rotate(180deg); }

    .instr-body {
      display: grid;
      grid-template-rows: 1fr;
      transition: grid-template-rows 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                  opacity 0.3s ease;
      opacity: 1;
    }
    .instr-body.collapsed {
      grid-template-rows: 0fr;
      opacity: 0;
    }
    .instr-body > div { overflow: hidden; }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>Autorellenador de plantillas Word</h1>
    <p class="subtitle">
      Crea un <code>.docx</code> con etiquetas entre corchetes ‚Äî <code>[NOMBRE]</code>, <code>[EMPRESA]</code> ‚Äî,
      etiquetas de fecha ‚Äî <code>[FECHA:fecha]</code> ‚Äî o etiquetas de g√©nero ‚Äî <code>[ARRENDATARIO:el|la]</code> ‚Äî,
      s√∫belo, rellena los campos y descarga el documento generado.
    </p>
  </div>

  <div class="card" id="instrCard">
    <div class="instr-header" id="instrToggle">
      <span class="card-title" style="margin-bottom:0;">C√≥mo preparar la plantilla ‚Äî <span style="color:#6366f1;">lee esto antes de empezar</span></span>
      <svg class="instr-chevron open" id="instrChevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
    <div class="instr-body" id="instrBody">
      <div>
        <div class="steps" style="margin-top:1.1rem;">
          <div class="step">
            <div class="step-num">1</div>
            <div class="step-text">Abre tu documento Word y escribe las etiquetas donde quieras insertar valores.</div>
          </div>
          <div class="step">
            <div class="step-num">2</div>
            <div class="step-text">Escribe cada etiqueta <strong>de una sola vez</strong>, sin cambiar el formato a mitad de ella ‚Äî si lo haces, Word la parte internamente y puede que no se detecte o que se detecte pero este lector la interprete con caracteres extra√±os.</div>
          </div>
          <div class="step">
            <div class="step-num">3</div>
            <div class="step-text">Hay tres tipos de etiqueta:
              <ul>
                <li><code class="c-text">[CAMPO]</code> ‚Äî texto libre; escribe el valor al rellenar el formulario. Por ejemplo <code>[NOMBRE]</code>, <code>[CIUDAD]</code>, <code>[EMPRESA]</code>.</li>
                <li><code class="c-date">[CAMPO:fecha]</code> ‚Äî selector de fecha; el valor se inserta como "21 de Febrero de 2026". Por ejemplo <code>[FECHA_FIRMA:fecha]</code>.</li>
                <li><code class="c-gender">[GRUPO:masc|fem]</code> ‚Äî concordancia de g√©nero; todas las etiquetas del mismo grupo se controlan con un √∫nico selector. Por ejemplo <code>[ARRENDATARIO:el|la]</code> y <code>arrendatari[ARRENDATARIO:o|a]</code> son el mismo grupo.</li>
              </ul>
            </div>
          </div>
          <div class="step">
            <div class="step-num">4</div>
            <div class="step-text">Guarda el archivo como <strong>.docx</strong> (no .doc ni .odt) y s√∫belo aqu√≠ abajo.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="warning" style="margin-top:1rem;">
    <div>üí° <strong>El nombre del archivo tambi√©n puede contener etiquetas.</strong> Si tu plantilla se llama <code>contrato_[NOMBRE]_[FECHA:fecha].docx</code>, el archivo descargado tendr√° esos valores ya sustituidos en el nombre.</div>
    <div style="margin-top:0.4rem;">üîí <strong>Todo ocurre en tu navegador.</strong> Ning√∫n dato se env√≠a a ning√∫n servidor.</div>
    <div style="margin-top:0.4rem;">üåê <strong>Requiere conexi√≥n a internet.</strong> Las librer√≠as necesarias se cargan desde CDN externos.</div>
  </div>

  <div class="dropzone" id="dropzone">
    <input type="file" id="fileInput" accept=".docx">
    <div class="dropzone-icon">üìÑ</div>
    <div class="dropzone-text">Arrastra tu plantilla aqu√≠ o haz clic para seleccionarla</div>
    <div class="dropzone-hint">Solo archivos .docx</div>
    <div class="filename hidden" id="filename">
      <span id="filenameText"></span>
    </div>
  </div>

  <button class="btn-reset hidden" id="resetBtn">‚úï Cambiar archivo</button>

  <div class="card hidden" id="tagsSection">
    <div class="card-title">Etiquetas detectadas</div>
    <div class="tags-list" id="tagsList"></div>
  </div>

  <div class="card hidden" id="formSection">
    <div class="card-title">Rellenar campos</div>
    <form id="fillForm" class="form-grid"></form>

    <hr class="divider">

    <div class="warning" id="warningBox">
      ‚ö†Ô∏è <strong>¬øFalta alguna etiqueta o aparecen caracteres extra√±os?</strong> Word puede haber dividido la etiqueta en fragmentos internos al cambiar el formato dentro de ella, lo que puede impedir su detecci√≥n o corromper el resultado. Vuelve a escribirla en la plantilla de un tir√≥n, sin aplicar cambios de estilo a mitad de la etiqueta.
    </div>

    <button class="btn" id="generateBtn" type="button" disabled>
      ‚¨á&nbsp; Generar documento
    </button>

    <button class="btn btn-pdf" id="pdfBtn" type="button" disabled>
      üìÑ&nbsp; Generar PDF
    </button>

    <p style="font-size:0.78rem;color:#9ca3af;margin-top:0.5rem;text-align:center;line-height:1.5;">
      En el di√°logo de impresi√≥n, desactiva <strong style="color:#6b7280;">¬´Encabezados y pies de p√°gina¬ª</strong> para un resultado limpio.
    </p>

    <div class="success-msg" id="successMsg">
      ‚úÖ Documento generado y descargado correctamente.
    </div>
  </div>

</div>

  <p style="text-align:center; margin-top:2.5rem; font-size:0.78rem; color:#b0b0c0;">
    Creado por <a href="https://github.com/yacoanix" target="_blank" style="color:#6366f1; text-decoration:none; font-weight:600;">Yacoanix</a>
    &nbsp;¬∑&nbsp; <a href="https://github.com/yacoanix" target="_blank" style="color:#9ca3af; text-decoration:none;">github.com/yacoanix</a>
  </p>

<script>
  const instrBody = document.getElementById('instrBody');
  const instrChevron = document.getElementById('instrChevron');

  function collapseInstr() {
    instrBody.classList.add('collapsed');
    instrChevron.classList.remove('open');
  }

  document.getElementById('instrToggle').addEventListener('click', () => {
    const collapsed = instrBody.classList.toggle('collapsed');
    instrChevron.classList.toggle('open', !collapsed);
  });

  let zipInstance = null;
  let originalXml = '';
  let detectedTags = [];
  let currentFile = null;
  let detectedGenderGroups = new Map();
  let detectedDateTags = [];

  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const filenameEl = document.getElementById('filename');
  const tagsSection = document.getElementById('tagsSection');
  const tagsList = document.getElementById('tagsList');
  const formSection = document.getElementById('formSection');
  const fillForm = document.getElementById('fillForm');
  const generateBtn = document.getElementById('generateBtn');
  const pdfBtn = document.getElementById('pdfBtn');
  const successMsg = document.getElementById('successMsg');

  document.getElementById('resetBtn').addEventListener('click', () => {
    zipInstance = null;
    originalXml = '';
    detectedTags = [];
    detectedDateTags = [];
    detectedGenderGroups = new Map();
    currentFile = null;
    fileInput.value = '';
    filenameEl.classList.add('hidden');
    document.getElementById('resetBtn').classList.add('hidden');
    tagsSection.classList.add('hidden');
    formSection.classList.add('hidden');
    successMsg.style.display = 'none';
    generateBtn.disabled = true;
    pdfBtn.disabled = true;
  });

  dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
  dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
  dropzone.addEventListener('drop', e => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
  });

  fileInput.addEventListener('change', () => {
    if (fileInput.files[0]) handleFile(fileInput.files[0]);
  });

  function handleFile(file) {
    if (currentFile) return;
    if (!file.name.endsWith('.docx')) {
      alert('Por favor selecciona un archivo .docx');
      return;
    }
    currentFile = file;

    document.getElementById('filenameText').textContent = 'üìé ' + file.name;
    filenameEl.classList.remove('hidden');
    document.getElementById('resetBtn').classList.remove('hidden');
    collapseInstr();
    successMsg.style.display = 'none';

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        zipInstance = new PizZip(e.target.result);
        originalXml = zipInstance.files['word/document.xml'].asText();
        const regex = /\[([^\]]+)\]/g;
        const allMatches = [...originalXml.matchAll(regex)];
        const genderRegex = /^(?:([^\]:]+):)?([^|]+)\|(.+)$/;
        const dateRegex = /^(.+):fecha$/i;
        detectedTags = [];
        detectedDateTags = [];
        detectedGenderGroups = new Map();
        const seenNormal = new Set();
        const seenDate = new Set();
        allMatches.forEach(m => {
          const inner = m[1];
          const gm = inner.match(genderRegex);
          if (gm) {
            const groupKey = gm[1] ? gm[1] : inner;
            const masc = gm[2];
            const fem = gm[3];
            const fullTag = '[' + inner + ']';
            if (!detectedGenderGroups.has(groupKey)) {
              detectedGenderGroups.set(groupKey, { displayName: groupKey, pairs: [] });
            }
            const group = detectedGenderGroups.get(groupKey);
            if (!group.pairs.some(p => p.fullTag === fullTag)) {
              group.pairs.push({ fullTag, masc, fem });
            }
          } else {
            const dm = inner.match(dateRegex);
            if (dm) {
              const key = dm[1];
              if (!seenDate.has(key)) {
                seenDate.add(key);
                detectedDateTags.push({ fullTag: '[' + inner + ']', key });
              }
            } else {
              if (!seenNormal.has(inner)) {
                seenNormal.add(inner);
                detectedTags.push(inner);
              }
            }
          }
        });
        renderTags(detectedTags, detectedDateTags, detectedGenderGroups);
        renderForm(detectedTags, detectedDateTags, detectedGenderGroups);
      } catch (err) {
        alert('Error al leer el archivo: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function formatDateES(val) {
    if (!val) return '';
    const [y, m, d] = val.split('-').map(Number);
    const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio',
                    'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    return d + ' de ' + months[m - 1] + ' de ' + y;
  }

  function renderTags(tags, dateTags, genderGroups) {
    tagsList.innerHTML = '';
    const totalItems = tags.length + dateTags.length + genderGroups.size;
    if (totalItems === 0) {
      tagsList.innerHTML = '<span style="color:#888;font-size:0.9rem;">No se detectaron etiquetas del tipo [ETIQUETA]</span>';
    } else {
      tags.forEach(tag => {
        const badge = document.createElement('span');
        badge.className = 'tag-badge';
        badge.textContent = '[' + tag + ']';
        tagsList.appendChild(badge);
      });
      dateTags.forEach(({ key }) => {
        const badge = document.createElement('span');
        badge.className = 'tag-badge--date';
        badge.textContent = 'üìÖ ' + key;
        tagsList.appendChild(badge);
      });
      genderGroups.forEach((group, groupKey) => {
        const badge = document.createElement('span');
        badge.className = 'tag-badge--gender';
        badge.textContent = '‚ö• ' + group.displayName + ' (' + group.pairs.map(p => p.masc).join('/') + '|' + group.pairs.map(p => p.fem).join('/') + ')';
        badge.title = group.pairs.map(p => p.fullTag).join(', ');
        tagsList.appendChild(badge);
      });
    }
    tagsSection.classList.remove('hidden');
  }

  function updateGenderPreview(groupKey, group) {
    const safeKey = groupKey.replace(/[^a-zA-Z0-9_]/g, '_');
    const checked = fillForm.querySelector('input[name="gender_' + safeKey + '"]:checked');
    const isMasc = !checked || checked.value === 'masc';
    const preview = fillForm.querySelector('#preview_' + safeKey);
    if (preview) {
      const values = group.pairs.map(p => isMasc ? p.masc : p.fem).join(', ');
      preview.innerHTML = 'Se insertar√°: <strong>' + values + '</strong>';
    }
  }

  function buildFilledXml() {
    let xmlFinal = originalXml;

    detectedDateTags.forEach(({ fullTag, key }) => {
      const input = document.getElementById('date_' + key);
      xmlFinal = xmlFinal.replaceAll(fullTag, formatDateES(input ? input.value : ''));
    });

    detectedGenderGroups.forEach((group, groupKey) => {
      const safeKey = groupKey.replace(/[^a-zA-Z0-9_]/g, '_');
      const checked = fillForm.querySelector('input[name="gender_' + safeKey + '"]:checked');
      const isMasc = !checked || checked.value === 'masc';
      group.pairs.forEach(({ fullTag, masc, fem }) => {
        xmlFinal = xmlFinal.replaceAll(fullTag, isMasc ? masc : fem);
      });
    });

    const valores = {};
    detectedTags.forEach(tag => {
      const input = document.getElementById('field_' + tag);
      valores[tag] = input ? input.value : '';
    });

    for (const [tag, valor] of Object.entries(valores)) {
      xmlFinal = xmlFinal.replaceAll('[' + tag + ']', valor);
    }

    return { xmlFinal, valores };
  }

  function renderForm(tags, dateTags, genderGroups) {
    fillForm.innerHTML = '';
    const totalItems = tags.length + dateTags.length + genderGroups.size;
    generateBtn.disabled = totalItems === 0;
    pdfBtn.disabled = totalItems === 0;

    tags.forEach(tag => {
      const field = document.createElement('div');
      field.className = 'field';

      const label = document.createElement('label');
      label.htmlFor = 'field_' + tag;
      const humanName = tag.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      label.innerHTML = humanName + ' <span class="tag-hint">[' + tag + ']</span>';

      const input = document.createElement('input');
      input.type = 'text';
      input.id = 'field_' + tag;
      input.name = tag;
      input.placeholder = 'Valor para [' + tag + ']';

      field.appendChild(label);
      field.appendChild(input);
      fillForm.appendChild(field);
    });

    if (dateTags.length > 0 && tags.length > 0) {
      const sep = document.createElement('div');
      sep.className = 'date-section-label';
      sep.textContent = 'Fecha';
      fillForm.appendChild(sep);
    }

    if (dateTags.length > 0) {
      const dateGrid = document.createElement('div');
      dateGrid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem;align-items:end;';

      dateTags.forEach(({ fullTag, key }) => {
        const field = document.createElement('div');
        field.className = 'field';

        const label = document.createElement('label');
        label.htmlFor = 'date_' + key;
        const humanName = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        label.style.flexDirection = 'column';
        label.style.alignItems = 'flex-start';
        label.innerHTML = '<span>' + humanName + '</span><span class="tag-hint">' + fullTag + '</span>';

        const input = document.createElement('input');
        input.type = 'date';
        input.id = 'date_' + key;
        input.name = 'date_' + key;

        field.appendChild(label);
        field.appendChild(input);
        dateGrid.appendChild(field);
      });

      fillForm.appendChild(dateGrid);
    }

    if (genderGroups.size > 0 && (tags.length > 0 || dateTags.length > 0)) {
      const sep = document.createElement('div');
      sep.className = 'gender-section-label';
      sep.textContent = 'G√©nero gramatical';
      fillForm.appendChild(sep);
    }

    genderGroups.forEach((group, groupKey) => {
      const safeKey = groupKey.replace(/[^a-zA-Z0-9_]/g, '_');
      const field = document.createElement('div');
      field.className = 'field';

      const label = document.createElement('label');
      const humanName = group.displayName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      const hints = group.pairs.map(p => '<span class="tag-hint">' + p.fullTag + '</span>').join(' ');
      label.innerHTML = humanName + ' ' + hints;

      const control = document.createElement('div');
      control.className = 'segmented-control';

      const idMasc = 'gender_' + safeKey + '_masc';
      const idFem = 'gender_' + safeKey + '_fem';

      const radioMasc = document.createElement('input');
      radioMasc.type = 'radio';
      radioMasc.name = 'gender_' + safeKey;
      radioMasc.id = idMasc;
      radioMasc.value = 'masc';
      radioMasc.checked = true;

      const labelMasc = document.createElement('label');
      labelMasc.htmlFor = idMasc;
      labelMasc.textContent = 'Masculino';

      const radioFem = document.createElement('input');
      radioFem.type = 'radio';
      radioFem.name = 'gender_' + safeKey;
      radioFem.id = idFem;
      radioFem.value = 'fem';

      const labelFem = document.createElement('label');
      labelFem.htmlFor = idFem;
      labelFem.textContent = 'Femenino';

      control.appendChild(radioMasc);
      control.appendChild(labelMasc);
      control.appendChild(radioFem);
      control.appendChild(labelFem);

      const preview = document.createElement('div');
      preview.className = 'gender-preview';
      preview.id = 'preview_' + safeKey;

      field.appendChild(label);
      field.appendChild(control);
      field.appendChild(preview);
      fillForm.appendChild(field);

      radioMasc.addEventListener('change', () => updateGenderPreview(groupKey, group));
      radioFem.addEventListener('change', () => updateGenderPreview(groupKey, group));
      updateGenderPreview(groupKey, group);
    });

    if (new URLSearchParams(location.search).has('dev')) {
      const fillBtn = document.createElement('button');
      fillBtn.type = 'button';
      fillBtn.textContent = 'Rellenar de prueba';
      fillBtn.style.cssText = 'display:block;width:100%;margin-bottom:1rem;padding:0.6rem 1rem;font-size:0.88rem;cursor:pointer;border:2px dashed #6366f1;border-radius:9px;background:#f5f3ff;color:#4f46e5;font-weight:700;text-align:center;';
      fillBtn.addEventListener('click', () => {
        const today = new Date().toISOString().slice(0, 10);
        tags.forEach(tag => {
          const el = document.getElementById('field_' + tag);
          if (el) el.value = tag.toLowerCase().replace(/_/g, ' ');
        });
        dateTags.forEach(({ key }) => {
          const el = document.getElementById('date_' + key);
          if (el) el.value = today;
        });
      });
      fillForm.prepend(fillBtn);
    }

    formSection.classList.remove('hidden');
  }

  generateBtn.addEventListener('click', async () => {
    if (!zipInstance || !originalXml) return;

    const { xmlFinal, valores } = buildFilledXml();

    try {
      const newZip = new PizZip(await currentFile.arrayBuffer());
      newZip.file('word/document.xml', xmlFinal);

      const blob = newZip.generate({ type: 'blob' });

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      let baseName = currentFile.name.replace(/\.docx$/i, '');

      detectedDateTags.forEach(({ fullTag, key }) => {
        const input = document.getElementById('date_' + key);
        baseName = baseName.replaceAll(fullTag, formatDateES(input ? input.value : ''));
      });

      for (const [tag, valor] of Object.entries(valores)) {
        baseName = baseName.replaceAll('[' + tag + ']', valor);
      }

      baseName = baseName.replace(/[/\\:*?"<>|]/g, '_').trim() || 'documento';
      a.download = baseName + '.docx';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      successMsg.style.display = 'block';
    } catch (err) {
      alert('Error al generar el documento: ' + err.message);
    }
  });

  pdfBtn.addEventListener('click', async () => {
    if (!zipInstance || !originalXml) return;

    const printWin = window.open('', '_blank');
    if (!printWin) { alert('Permite ventanas emergentes para generar el PDF.'); return; }

    const { xmlFinal } = buildFilledXml();

    try {
      const newZip = new PizZip(await currentFile.arrayBuffer());
      newZip.file('word/document.xml', xmlFinal);
      const blob = newZip.generate({ type: 'blob' });
      const arrayBuffer = await blob.arrayBuffer();

      const uint8 = new Uint8Array(arrayBuffer);
      let binary = '';
      for (let i = 0; i < uint8.length; i += 8192)
        binary += String.fromCharCode.apply(null, uint8.subarray(i, i + 8192));
      const b64 = btoa(binary);

      const { valores } = buildFilledXml();
      let baseName = currentFile.name.replace(/\.docx$/i, '');
      detectedDateTags.forEach(({ fullTag, key }) => {
        const input = document.getElementById('date_' + key);
        baseName = baseName.replaceAll(fullTag, formatDateES(input ? input.value : ''));
      });
      for (const [tag, valor] of Object.entries(valores)) {
        baseName = baseName.replaceAll('[' + tag + ']', valor);
      }
      baseName = baseName.replace(/[/\\:*?"<>|]/g, '_').trim() || 'documento';

      const twipToCm = v => +(parseInt(v, 10) / 1440 * 2.54).toFixed(3);
      const marTag = (xmlFinal.match(/<w:pgMar\s[^/]*/) || [])[0] || '';
      const pgM = attr => { const m = marTag.match(new RegExp('w:' + attr + '="(\\d+)"')); return m ? twipToCm(m[1]) : 2.5; };
      const mTop = pgM('top'), mRight = pgM('right'), mBottom = pgM('bottom'), mLeft = pgM('left');

      printWin.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8">
        <title>${baseName}</title>
        <style>
          @page {
            margin: ${mTop}cm ${mRight}cm ${mBottom}cm ${mLeft}cm;
            @top-left { content: none; }
            @top-center { content: none; }
            @top-right { content: none; }
            @bottom-left { content: none; }
            @bottom-center { content: none; }
            @bottom-right { content: none; }
          }
          body { margin: 0; padding: 0; }
          .docx-wrapper { background: none !important; padding: 0 !important; margin: 0 !important; }
          .docx-wrapper > section { box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; width: auto !important; min-height: auto !important; }
        </style>
      </head><body><div id="c"></div><script type="module">
        import { renderAsync } from 'https://esm.sh/docx-preview';
        const bin = atob('${b64}');
        const buf = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
        await renderAsync(buf.buffer, document.getElementById('c'), null, {
          renderHeaders: false,
          renderFooters: false,
          ignoreWidth: true,
          ignoreHeight: true,
          breakPages: false,
        });
        window.print();
        window.close();
      <\/script></body></html>`);
      printWin.document.close();
    } catch (err) {
      printWin.close();
      alert('Error al generar el PDF: ' + err.message);
    }
  });
</script>
</body>
</html>
